# RISC-V中的用户态中断

## RISC-V Extension N

RISC-V N扩展是RISC-V的用户态中断扩展，该扩展增加了一些CSR寄存器和一条指令。

增加的CSR寄存器为：```ustatus```, ```utvec```, ```uip```,```uie```,```sedeleg```,```sideleg```,```uscratch```,```uepc```,```ucause```,```utval```, 这些寄存器与M态和S态的异常中断CSR寄存器类似，功能也是一致的。

新增的一条指令为:```uret```，与```mret```或```sret```类似，均为从异常状态返回。

## 用户态中断处理流程

![用户态中断与异常的处理流程](https://gallium70.github.io/rv-n-ext-impl/assets/user_trap_flow.drawio.svg)

和M态或S态异常处理基本一致。

## UINTC跨核中断控制器

用户态跨核软件中断是用户态中断的重要应用。

CPU内部存在一个物理的部件：UINTC，其核心部分是对于中断发送方和接收方的存储，由若干寄存器承担，并由MMIO提供操作接口。发送方和接收方各有一个UIID(User Interrupt ID)用于标识，不必与UID保持一致。

设R，S分别为接收方和发送方个数，N为上下文个数，则规定了R，S不超过4096，N不超过2048。如果应用中实际数量大于这两个限制，则由操作系统进行维护。

UINTC会提供下列寄存器：

- 使能寄存器```enable```: R*S的bool矩阵，存储s到r是否可以发送中断，由OS维护。

- 等待寄存器```pending```: R*S的bool矩阵，表示是否有从s到r的正在等待的中断。

- 发送方UIID寄存器```sender_uiid```

- 接收方UIID寄存器```receiver_uiid```

- 发送寄存器```send```: 向此寄存器写入接收方的 UIID 以请求向后者发送用户态中断。

- 发送状态寄存器 ```status```: 从此寄存器读取检查上一次发送是否成功。

- 领取寄存器```claim```: 接收方用于领取当前中断的寄存器。

  
## 跨核中断的软件流程

### 槽位的申请与释放

用户进程可以向操作系统申请发送方和接收方槽位。操作系统会将为新分配的槽位分配 UIID，写入对应槽位的 ```sender_uiid``` 或 ```receiver_uiid```，并将用户进程可以操作的 4 KiB 页映射给用户进程。

### 中断发送

1. 用户进程尝试向自己拥有的发送方槽位的 `send` 写入接收方 UIID。
2. 如果用户进程关心发送是否成功，读取 `status`。如果为 `1`（非 `0`），发送成功，否则可以发起系统调用等，要求操作系统立即响应。

### 中断处理

1. 用户进程确认收到的中断包括用户态跨核软件中断。
2. 读取此进程设置监听的接收方槽位对应的 `claim` 获取中断来源。获取一个中断来源后，该来源的中断从中断控制器中清除。
3. 重复此过程读取其余正在等待的中断，直到返回值为 `0`，表示已无更多正在等待的中断。此时中断控制器不再置 USIP 为 `1`。
